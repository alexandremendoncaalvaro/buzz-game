<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Buzzer</title>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div>
      <input id="secret" placeholder="Resposta secreta" />
      <input
        id="maxPts"
        type="number"
        value="200"
        placeholder="Pontos/Segundos máximos"
      />
      <button id="start">Iniciar Rodada</button>
      <button id="cancel" style="display: none">Cancelar Rodada</button>
    </div>
    <div id="roundStatus" style="display: none">
      <h3>Rodada Ativa</h3>
      <p id="currentRound"></p>
    </div>
    <div id="buzzSection" style="display: none">
      <h3 id="buzzPlayer"></h3>
      <button id="correct">Correto</button>
      <button id="incorrect">Incorreto</button>
    </div>
    <div>
      <h3>Placar</h3>
      <ul id="scores"></ul>
    </div>
    <div>
      <h3>Histórico</h3>
      <ul id="history"></ul>
    </div>
    <script>
      const socket = io("/admin");
      let currentBuzzPlayer = null;

      document.getElementById("start").onclick = () => {
        const secret = document.getElementById("secret").value.trim();
        const maxPoints = +document.getElementById("maxPts").value;
        if (!secret) return alert("Digite a resposta secreta!");
        socket.emit("startRound", { secretAnswer: secret, maxPoints });
      };

      document.getElementById("cancel").onclick = () => {
        socket.emit("cancelRound");
      };

      document.getElementById("correct").onclick = () => {
        if (currentBuzzPlayer) {
          socket.emit("answerResult", {
            playerId: currentBuzzPlayer,
            correct: true,
          });
          document.getElementById("buzzSection").style.display = "none";
        }
      };

      document.getElementById("incorrect").onclick = () => {
        if (currentBuzzPlayer) {
          socket.emit("answerResult", {
            playerId: currentBuzzPlayer,
            correct: false,
          });
          document.getElementById("buzzSection").style.display = "none";
        }
      };

      socket.on("scoreUpdate", (board) => {
        const ul = document.getElementById("scores");
        ul.innerHTML = "";
        board.forEach((p) => {
          const li = document.createElement("li");
          li.textContent = `${p.name}: ${p.score}`;
          if (p.ip) {
            li.textContent += ` (${p.ip})`;
          }
          ul.appendChild(li);
        });
      });

      socket.on("buzzed", ({ playerId, name }) => {
        currentBuzzPlayer = playerId;
        document.getElementById(
          "buzzPlayer"
        ).textContent = `${name} fez buzz! A resposta está correta?`;
        document.getElementById("buzzSection").style.display = "block";
      });

      socket.on("historyUpdate", (history) => {
        const ul = document.getElementById("history");
        ul.innerHTML = "";
        history.forEach((round) => {
          const li = document.createElement("li");
          if (round.cancelled) {
            li.textContent = `${round.timestamp} - Rodada cancelada [${round.secret}]`;
            li.style.color = "red";
          } else {
            const status = round.correct ? "✓" : "✗";
            const points = round.correct ? `(+${round.points}pts)` : "";
            li.textContent = `${round.timestamp} - ${round.playerName}: ${status} ${points} [${round.secret}]`;
          }
          ul.appendChild(li);
        });
      });

      socket.on("roundStarted", ({ secret, maxPoints }) => {
        document.getElementById("roundStatus").style.display = "block";
        document.getElementById(
          "currentRound"
        ).textContent = `Pergunta: ${secret} | Máximo: ${maxPoints} pontos`;
        document.getElementById("start").style.display = "none";
        document.getElementById("cancel").style.display = "inline";
        document.getElementById("secret").value = "";
      });

      socket.on("roundReset", () => {
        document.getElementById("roundStatus").style.display = "none";
        document.getElementById("buzzSection").style.display = "none";
        document.getElementById("start").style.display = "inline";
        document.getElementById("cancel").style.display = "none";
      });
    </script>
  </body>
</html>
